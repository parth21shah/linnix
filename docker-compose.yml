# Linnix - eBPF system monitoring
#
# Quick Start:
#   ./quickstart.sh
#
# Manual Start:
#   docker compose up -d
#
# Access:
#   - API & Dashboard: http://localhost:3000
#   - LLM Server: http://localhost:8090
#
# Platform Notes:
#   - Linux x86_64: Full eBPF kernel instrumentation (recommended)
#   - macOS: eBPF monitors Docker VM processes only (via bridge network)
#   - ARM64: x86_64 emulation via Rosetta/QEMU (slower performance)

services:
  # Cognitod - eBPF monitoring daemon
  # Security: root + minimal caps (CAP_BPF + CAP_PERFMON only)
  cognitod:
    image: ${COGNITOD_IMAGE:-linnix-cognitod}
    container_name: linnix-cognitod

    network_mode: host
    pid: host

    # Minimal capabilities (requires Linux 5.8+)
    cap_add:
      - BPF
      - PERFMON
      - SYS_ADMIN
    
    ulimits:
      memlock: -1

    security_opt:
      - no-new-privileges:true
      # - apparmor:unconfined
      # - seccomp:unconfined

    read_only: true
    tmpfs:
      - /tmp
      - /var/run

    volumes:
      - /sys/kernel/btf:/sys/kernel/btf:ro
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - /sys/fs/bpf:/sys/fs/bpf:rw
      - ./configs:/etc/linnix:ro
      - linnix-data:/var/lib/linnix:rw

    environment:
      - RUST_LOG=info
      - LINNIX_CONFIG=/etc/linnix/linnix.toml

    # Demo mode: Run all demo scenarios on startup
    # Uncomment the line below to enable demo mode
    # command: ["cognitod", "--config", "/etc/linnix/linnix.toml", "--handler", "rules:/etc/linnix/rules.yaml", "--demo", "all"]

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # LLM Server - Linnix 3B distilled model
  llama-server:
    image: ${LLAMA_IMAGE:-ghcr.io/ggml-org/llama.cpp:server}
    container_name: linnix-llm
    volumes:
      - ./models:/models:ro
    ports:
      - "8090:8090"
    command: [
      "--host", "0.0.0.0",
      "--port", "8090", 
      "-m", "/models/linnix-3b-distilled-q5_k_m.gguf",
      "--alias", "linnix-3b-distilled",
      "--ctx-size", "4096",
      "-t", "4",
      "--log-disable"
    ]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 15s
      timeout: 10s
      retries: 3

volumes:
  linnix-data:
    driver: local
