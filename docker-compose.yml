# Linnix - eBPF system monitoring
#
# Quick Start:
#   ./quickstart.sh
#
# Manual Start:
#   docker compose up -d
#
# Access:
#   - API & Dashboard: http://localhost:3000
#   - LLM Server: http://localhost:8090

version: '3.8'

services:
  # Cognitod - eBPF monitoring daemon
  # Security: root + minimal caps (CAP_BPF + CAP_PERFMON only)
  cognitod:
    image: ghcr.io/linnix-os/cognitod:latest
    # Fallback: build locally if image pull fails
    build:
      context: .
      dockerfile: Dockerfile
    container_name: linnix-cognitod

    network_mode: host
    pid: host

    # Minimal capabilities (requires Linux 5.8+)
    cap_add:
      - BPF
      - PERFMON

    security_opt:
      - no-new-privileges:true

    read_only: true
    tmpfs:
      - /tmp
      - /var/run

    volumes:
      - /sys/kernel/btf:/sys/kernel/btf:ro
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - ./configs:/etc/linnix:ro
      - linnix-data:/var/lib/linnix:rw

    environment:
      - RUST_LOG=info
      - LINNIX_CONFIG=/etc/linnix/linnix.toml

    # Demo mode: Run all demo scenarios on startup
    # Uncomment the line below to enable demo mode
    # command: ["cognitod", "--config", "/etc/linnix/linnix.toml", "--handler", "rules:/etc/linnix/rules.yaml", "--demo", "all"]

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # LLM Server - Linnix 3B distilled model
  llama-server:
    image: ghcr.io/ggerganov/llama.cpp:server
    container_name: linnix-llm
    volumes:
      - ./models:/models:ro
    ports:
      - "8090:8090"
    command: [
      "--host", "0.0.0.0",
      "--port", "8090", 
      "-m", "/models/linnix-3b-distilled-q5_k_m.gguf",
      "--alias", "linnix-3b-distilled",
      "--ctx-size", "4096",
      "-t", "4",
      "--log-disable"
    ]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Web Dashboard
  dashboard:
    image: nginx:alpine
    container_name: linnix-dashboard
    network_mode: host
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./dashboard/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - cognitod
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  linnix-data:
    driver: local
