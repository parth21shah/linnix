<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linnix Dashboard - eBPF Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d30 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(45deg, #0066CC, #00FF00);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(45deg, #0066CC, #00FF00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .status-indicators {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-dot.online { background-color: #28a745; }
        .status-dot.offline { background-color: #dc3545; }
        .status-dot.loading { background-color: #ffc107; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(0, 102, 204, 0.3);
            box-shadow: 0 8px 32px rgba(0, 102, 204, 0.1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0066CC;
            line-height: 1;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #888;
            margin-top: 0.25rem;
        }
        
        .process-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .process-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid transparent;
        }
        
        .process-item.high-cpu {
            border-left-color: #ff6600;
        }
        
        .process-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .process-name {
            font-weight: 500;
            color: #ffffff;
        }
        
        .process-pid {
            font-size: 0.8rem;
            color: #888;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
        }
        
        .process-cpu {
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .cpu-high { background-color: rgba(255, 102, 0, 0.2); color: #ff6600; }
        .cpu-medium { background-color: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .cpu-low { background-color: rgba(40, 167, 69, 0.2); color: #28a745; }
        
        .events-stream {
            height: 300px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .event-item {
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-left: 3px solid #0066CC;
            background: rgba(0, 102, 204, 0.05);
            border-radius: 6px;
            transition: all 0.2s ease;
            animation: slideIn 0.3s ease;
        }
        
        .event-item:hover {
            background: rgba(0, 102, 204, 0.15);
            transform: translateX(4px);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .event-time {
            color: #888;
        }
        
        .event-type {
            color: #0066CC;
            font-weight: 600;
        }
        
        .insights-panel {
            grid-column: 1 / -1;
        }
        
        .insight-item {
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .insight-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .insight-icon {
            width: 24px;
            height: 24px;
            background: #00ff00;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .insight-confidence {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #888;
        }
        
        .error {
            color: #dc3545;
            padding: 1rem;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.2);
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(0, 102, 204, 0.5);
            background: rgba(0, 102, 204, 0.1);
            color: #0066CC;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background: rgba(0, 102, 204, 0.2);
            border-color: #0066CC;
        }
        
        .footer {
            text-align: center;
            padding: 2rem;
            color: #666;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">L</div>
                <div class="logo-text">Linnix</div>
            </div>
            <div class="status-indicators">
                <div class="status-indicator">
                    <span class="status-dot loading" id="cognitod-status"></span>
                    <span>Cognitod</span>
                </div>
                <div class="status-indicator">
                    <span class="status-dot loading" id="llm-status"></span>
                    <span>AI Model</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <!-- System Overview -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">System Overview</h3>
                </div>
                <div class="metric-value" id="events-per-sec">--</div>
                <div class="metric-label">Events per second</div>
                <div style="margin-top: 1rem;">
                    <div class="metric-value" style="font-size: 1.2rem;" id="active-processes">--</div>
                    <div class="metric-label">Active processes</div>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">AI Status</h3>
                </div>
                <div class="metric-value" id="insights-count">--</div>
                <div class="metric-label">Total insights</div>
                <div style="margin-top: 1rem;">
                    <div class="metric-value" style="font-size: 1.2rem;" id="last-insight-time">--</div>
                    <div class="metric-label">Last analysis</div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Performance</h3>
                </div>
                <div class="metric-value" style="color: #00ff00;" id="cpu-overhead">&lt;1%</div>
                <div class="metric-label">CPU overhead</div>
                <div style="margin-top: 1rem;">
                    <div class="metric-value" style="font-size: 1.2rem;" id="memory-usage">--</div>
                    <div class="metric-label">Memory usage</div>
                </div>
            </div>
        </div>

        <!-- Top Processes -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Top Processes</h3>
            </div>
            <div class="process-list" id="processes-list">
                <div class="loading">Loading processes...</div>
            </div>
        </div>

        <!-- Recent Events -->
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h3 class="card-title">Live Events Stream</h3>
            </div>
            <div class="events-stream" id="events-stream">
                <div class="loading">Connecting to event stream...</div>
            </div>
        </div>

        <!-- AI Insights Panel -->
        <div class="card insights-panel" style="margin-top: 2rem;">
            <div class="card-header">
                <h3 class="card-title">ü§ñ AI Insights</h3>
            </div>
            <div id="insights-panel">
                <div class="loading">Loading AI insights...</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card full-width" style="margin-top: 2rem;">
            <div class="card-header">
                <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="quick-actions">
                <a href="http://localhost:3000/processes" target="_blank" class="btn">View All Processes</a>
                <a href="http://localhost:3000/metrics" target="_blank" class="btn">Prometheus Metrics</a>
                <a href="http://localhost:8090/health" target="_blank" class="btn">LLM Health Check</a>
                <a href="https://github.com/linnix-os/linnix" target="_blank" class="btn">GitHub Repository</a>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Linnix Dashboard - eBPF-powered Linux observability with AI insights</p>
        <p>üêß Open Source ‚Ä¢ ‚ö° &lt;1% CPU Overhead ‚Ä¢ üß† Local pattern detection</p>
    </div>

    <script>
        // Configuration
        const COGNITOD_BASE = '';
        const LLM_BASE = 'http://localhost:8090';
        
        // State
        let eventCount = 0;
        let lastEventTime = Date.now();
        let insightsHistory = []; // Keep track of all insights
        let lastInsightData = null; // Track last fetched data to detect changes
        
        // Service health checks
        async function checkServiceHealth() {
            try {
                const cognitodResponse = await fetch(`${COGNITOD_BASE}/healthz`);
                const cognitodHealthy = cognitodResponse.ok;
                
                document.getElementById('cognitod-status').className = 
                    `status-dot ${cognitodHealthy ? 'online' : 'offline'}`;
                
                if (cognitodHealthy) {
                    loadSystemData();
                    loadProcesses();
                    loadInsights();
                }
            } catch (error) {
                console.error('Cognitod health check failed:', error);
                document.getElementById('cognitod-status').className = 'status-dot offline';
            }
            
            try {
                const llmResponse = await fetch(`${LLM_BASE}/health`);
                const llmHealthy = llmResponse.ok;
                
                document.getElementById('llm-status').className = 
                    `status-dot ${llmHealthy ? 'online' : 'offline'}`;
            } catch (error) {
                console.error('LLM health check failed:', error);
                document.getElementById('llm-status').className = 'status-dot offline';
            }
        }
        
        // Load system overview data
        async function loadSystemData() {
            try {
                // Get process count from /processes endpoint
                const processResponse = await fetch(`${COGNITOD_BASE}/processes`);
                const processes = await processResponse.json();
                
                // Count unique processes
                const uniquePids = new Set(processes.map(p => p.pid));
                document.getElementById('active-processes').textContent = uniquePids.size;
                
                // Get memory usage and other metrics from /metrics endpoint
                try {
                    const metricsResponse = await fetch(`${COGNITOD_BASE}/metrics`);
                    const metrics = await metricsResponse.json();
                    
                    // Parse RSS memory (now in KB after bug fix)
                    if (metrics.rss) {
                        const memMB = Math.round(metrics.rss / 1024);
                        document.getElementById('memory-usage').textContent = `${memMB} MB`;
                        document.getElementById('memory-usage').style.color = memMB < 512 ? '#00ff00' : '#ffc107';
                    } else {
                        document.getElementById('memory-usage').textContent = 'N/A';
                    }
                    
                    // Update CPU overhead
                    if (metrics.cpu_percent !== undefined) {
                        const cpuPercent = metrics.cpu_percent.toFixed(1);
                        document.getElementById('cpu-overhead').textContent = `${cpuPercent}%`;
                        // Color code: green < 5%, yellow 5-20%, red > 20%
                        if (cpuPercent < 5) {
                            document.getElementById('cpu-overhead').style.color = '#00ff00';
                        } else if (cpuPercent < 20) {
                            document.getElementById('cpu-overhead').style.color = '#ffc107';
                        } else {
                            document.getElementById('cpu-overhead').style.color = '#ff6600';
                        }
                    }
                    
                    // Update events per second from metrics if available
                    if (metrics.events_per_sec !== undefined) {
                        document.getElementById('events-per-sec').textContent = Math.round(metrics.events_per_sec);
                    }
                } catch (error) {
                    console.error('Failed to parse metrics:', error);
                    document.getElementById('memory-usage').textContent = 'N/A';
                }
                
            } catch (error) {
                console.error('Failed to load system data:', error);
            }
        }
        
        // Load top processes
        async function loadProcesses() {
            try {
                // Get top consumers from /status endpoint
                const statusResponse = await fetch(`${COGNITOD_BASE}/status`);
                const status = await statusResponse.json();
                const topRss = status.top_rss || [];
                const topCpu = status.top_cpu || [];
                
                console.log('Fetched processes - CPU:', topCpu.length, 'RSS:', topRss.length);
                
                // Combine CPU and memory into a unified list
                const metricsMap = new Map();
                
                // Add memory data
                for (const proc of topRss) {
                    metricsMap.set(proc.pid, {
                        pid: proc.pid,
                        comm: proc.comm,
                        mem_percent: proc.mem_percent,
                        cpu_percent: 0
                    });
                }
                
                // Add CPU data (merge if already exists)
                for (const proc of topCpu) {
                    if (metricsMap.has(proc.pid)) {
                        metricsMap.get(proc.pid).cpu_percent = proc.cpu_percent;
                    } else {
                        metricsMap.set(proc.pid, {
                            pid: proc.pid,
                            comm: proc.comm,
                            mem_percent: 0,
                            cpu_percent: proc.cpu_percent
                        });
                    }
                }
                
                // Convert to array and sort by combined score (CPU + Memory)
                const topProcesses = Array.from(metricsMap.values())
                    .sort((a, b) => {
                        const scoreA = a.cpu_percent + a.mem_percent;
                        const scoreB = b.cpu_percent + b.mem_percent;
                        return scoreB - scoreA;
                    })
                    .slice(0, 15);
                
                console.log('Top processes to display:', topProcesses.length, topProcesses);
                
                const processesHtml = topProcesses.length > 0 ? 
                    topProcesses.map(proc => {
                        const cpuPercent = proc.cpu_percent || 0;
                        const memPercent = proc.mem_percent || 0;
                        const maxValue = Math.max(cpuPercent, memPercent);
                        
                        // Color code by highest value
                        const valueClass = maxValue > 20 ? 'cpu-high' : 
                                         maxValue > 5 ? 'cpu-medium' : 'cpu-low';
                        
                        // Show both metrics
                        const metrics = [];
                        if (cpuPercent > 0) {
                            metrics.push(`üî• ${cpuPercent.toFixed(1)}% CPU`);
                        }
                        if (memPercent > 0) {
                            metrics.push(`üíæ ${memPercent.toFixed(1)}% RAM`);
                        }
                        const metricsText = metrics.length > 0 ? metrics.join(' ‚Ä¢ ') : 'tracked';
                        
                        console.log(`Process ${proc.comm}: CPU=${cpuPercent}, MEM=${memPercent}, metrics=${metricsText}`);
                        
                        return `
                            <div class="process-item ${maxValue > 20 ? 'high-cpu' : ''}">
                                <div class="process-info">
                                    <div class="process-name">${proc.comm || 'unknown'}</div>
                                    <div class="process-pid">PID ${proc.pid}</div>
                                </div>
                                <div class="process-cpu ${valueClass}" style="font-size: 0.75rem; text-align: right;">
                                    ${metricsText}
                                </div>
                            </div>
                        `;
                    }).join('') :
                    '<div class="loading">No processes with metrics yet. <br><small style="color: #888;">CPU data requires time-based sampling (warmup in progress)</small></div>';
                
                console.log('Setting innerHTML, length:', processesHtml.length);
                document.getElementById('processes-list').innerHTML = processesHtml;
                
            } catch (error) {
                console.error('Failed to load processes:', error);
                document.getElementById('processes-list').innerHTML = 
                    '<div class="error">Failed to load processes</div>';
            }
        }
        
        // Load AI insights
        async function loadInsights() {
            try {
                const response = await fetch(`${COGNITOD_BASE}/insights`);
                const data = await response.json();
                
                // Check if data has changed
                const dataStr = JSON.stringify(data);
                if (dataStr === lastInsightData) {
                    return; // No new insights
                }
                lastInsightData = dataStr;
                
                // Handle both array format and {risks, summary} format
                const insights = data.risks || (Array.isArray(data) ? data : []);
                const summary = data.summary || '';
                
                // Add timestamp to new insight
                const timestamp = new Date().toLocaleTimeString();
                
                // Append to history
                if (summary || insights.length > 0) {
                    insightsHistory.unshift({
                        timestamp,
                        summary,
                        risks: insights
                    });
                    
                    // Keep only last 10 insight batches
                    if (insightsHistory.length > 10) {
                        insightsHistory = insightsHistory.slice(0, 10);
                    }
                }
                
                // Update AI Status card
                const totalInsights = insightsHistory.reduce((sum, h) => 
                    sum + (h.summary ? 1 : 0) + h.risks.length, 0);
                document.getElementById('insights-count').textContent = totalInsights || '0';
                
                // Update last insight time
                const timeStr = insightsHistory.length > 0 ? timestamp : 'Never';
                document.getElementById('last-insight-time').textContent = timeStr;
                document.getElementById('last-insight-time').style.fontSize = insightsHistory.length > 0 ? '1.2rem' : '1rem';
                document.getElementById('last-insight-time').style.color = insightsHistory.length > 0 ? '#00ff00' : '#888';
                
                // Render all insights in history
                let insightsHtml = '';
                
                for (const batch of insightsHistory) {
                    // Show summary with enhanced structured data
                    if (batch.summary) {
                        const metrics = data.metrics || {};
                        const topCpu = data.top_cpu || [];
                        const topMemory = data.top_memory || [];
                        const alerts = data.alerts || [];
                        
                        insightsHtml += `
                            <div class="insight-item" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05)); border-left: 4px solid #3b82f6;">
                                <div class="insight-header">
                                    <div class="insight-icon">ü§ñ</div>
                                    <strong>AI System Analysis</strong>
                                    <span style="margin-left: auto; font-size: 0.85rem; color: #888;">${batch.timestamp}</span>
                                </div>
                                
                                ${metrics.cpu_percent ? `
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; font-size: 0.9rem;">
                                        <div>
                                            <div style="color: #888; font-size: 0.75rem;">CPU Usage</div>
                                            <div style="font-size: 1.2rem; font-weight: bold; color: ${parseFloat(metrics.cpu_percent) > 80 ? '#ef4444' : parseFloat(metrics.cpu_percent) > 50 ? '#f59e0b' : '#10b981'};">
                                                ${metrics.cpu_percent}%
                                            </div>
                                        </div>
                                        <div>
                                            <div style="color: #888; font-size: 0.75rem;">Memory</div>
                                            <div style="font-size: 1.2rem; font-weight: bold; color: ${parseFloat(metrics.mem_percent) > 80 ? '#ef4444' : parseFloat(metrics.mem_percent) > 60 ? '#f59e0b' : '#10b981'};">
                                                ${metrics.mem_percent}%
                                            </div>
                                        </div>
                                        <div>
                                            <div style="color: #888; font-size: 0.75rem;">Load Avg</div>
                                            <div style="font-size: 1.2rem; font-weight: bold;">
                                                ${metrics.load_avg ? metrics.load_avg[0] : 'N/A'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${topCpu.length > 0 ? `
                                <div style="margin-top: 0.75rem;">
                                    <div style="color: #f59e0b; font-weight: bold; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>üî•</span> Top CPU Consumers
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.85rem;">
                                        ${topCpu.map(proc => `
                                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 4px;">
                                                <span><strong>${proc.comm}</strong> (PID ${proc.pid})</span>
                                                <span style="color: #f59e0b; font-weight: bold;">${proc.cpu_percent}%</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${topMemory.length > 0 ? `
                                <div style="margin-top: 0.75rem;">
                                    <div style="color: #3b82f6; font-weight: bold; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>üíæ</span> Top Memory Consumers
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.85rem;">
                                        ${topMemory.map(proc => `
                                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0.5rem; background: rgba(59, 130, 246, 0.1); border-radius: 4px;">
                                                <span><strong>${proc.comm}</strong> (PID ${proc.pid})</span>
                                                <span style="color: #3b82f6; font-weight: bold;">${proc.mem_percent}%</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${alerts.length > 0 ? `
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3);">
                                    <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>‚ö†Ô∏è</span> Active Alerts
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem;">
                                        ${alerts.map(alert => `
                                            <div style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                                <div><strong>${alert.comm}</strong> (PID ${alert.pid})</div>
                                                <div style="color: #fca5a5; margin-top: 0.25rem;">${alert.reason}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                    <div style="font-weight: bold; margin-bottom: 0.5rem; color: #fbbf24;">
                                        üìù Analysis Summary
                                    </div>
                                    <div style="line-height: 1.6; color: #e5e7eb;">
                                        ${batch.summary}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Show risks if available
                    if (batch.risks.length > 0) {
                        insightsHtml += batch.risks.map(insight => `
                            <div class="insight-item" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05)); border-left: 4px solid #ef4444;">
                                <div class="insight-header">
                                    <div class="insight-icon">‚ö†Ô∏è</div>
                                    <div class="insight-confidence">${Math.round((insight.confidence || 0.5) * 100)}%</div>
                                    <strong>${insight.class || 'Risk Detected'}</strong>
                                    <span style="margin-left: auto; font-size: 0.85rem; color: #888;">${batch.timestamp}</span>
                                </div>
                                <div style="margin-bottom: 0.5rem; margin-top: 0.75rem;">
                                    <strong>Process:</strong> ${insight.primary_process || 'System'}
                                </div>
                                <div style="margin-bottom: 0.75rem;">
                                    ${insight.why || insight.description || 'Analysis in progress...'}
                                </div>
                                ${insight.actions && insight.actions.length > 0 ? `
                                    <div style="font-size: 0.9rem; color: #888;">
                                        <strong>Recommended actions:</strong>
                                        <ul style="margin: 0.5rem 0 0 1rem;">
                                            ${insight.actions.map(action => `<li>${action}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('');
                    }
                }
                
                if (insightsHtml) {
                    document.getElementById('insights-panel').innerHTML = insightsHtml;
                } else {
                    document.getElementById('insights-panel').innerHTML = 
                        '<div class="loading">No insights available yet. AI analysis runs every 30 seconds.</div>';
                }
                
            } catch (error) {
                console.error('Failed to load insights:', error);
                document.getElementById('insights-panel').innerHTML = 
                    '<div class="error">Failed to load AI insights</div>';
            }
        }
        
        // Connect to events stream
        function connectEventStream() {
            try {
                const eventSource = new EventSource(`${COGNITOD_BASE}/stream`);
                
                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleNewEvent(data);
                    } catch (e) {
                        console.error('Failed to parse event data:', e);
                    }
                };
                
                eventSource.onerror = function(error) {
                    console.error('EventSource failed:', error);
                    document.getElementById('events-stream').innerHTML = 
                        '<div class="error">Event stream disconnected. Retrying in 5 seconds...</div>';
                    
                    setTimeout(() => {
                        eventSource.close();
                        connectEventStream();
                    }, 5000);
                };
                
            } catch (error) {
                console.error('Failed to connect to event stream:', error);
                document.getElementById('events-stream').innerHTML = 
                    '<div class="error">Failed to connect to event stream</div>';
            }
        }
        
        // Handle new events from stream
        function handleNewEvent(event) {
            eventCount++;
            const eventsContainer = document.getElementById('events-stream');
            
            const eventTime = new Date().toLocaleTimeString();
            const eventElement = document.createElement('div');
            
            // Use event_type_name from backend API (e.g., 'exec', 'fork', 'exit')
            let eventLabel = event.event_type_name || 'unknown';
            
            // Determine event type and styling
            let eventIcon = 'üìù';
            let eventColor = '#0066CC';
            
            switch(eventLabel) {
                case 'fork':
                    eventIcon = 'üîÑ';
                    eventColor = '#ffc107';
                    break;
                case 'exec':
                    eventIcon = '‚ñ∂Ô∏è';
                    eventColor = '#00ff00';
                    break;
                case 'exit':
                    eventIcon = '‚úì';
                    eventColor = '#888';
                    break;
            }
            
            // Get user info
            const userName = event.uid === 0 ? 'root' : `uid:${event.uid}`;
            
            // Build metric badges
            const metrics = [];
            if (event.cpu_percent && event.cpu_percent > 0) {
                const cpuColor = event.cpu_percent > 50 ? '#ff6600' : event.cpu_percent > 20 ? '#ffc107' : '#00ff00';
                metrics.push(`<span style="background: rgba(${cpuColor === '#ff6600' ? '255,102,0' : cpuColor === '#ffc107' ? '255,193,7' : '0,255,0'}, 0.2); color: ${cpuColor}; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">CPU ${event.cpu_percent.toFixed(1)}%</span>`);
            }
            if (event.mem_percent && event.mem_percent > 0) {
                metrics.push(`<span style="background: rgba(59,130,246,0.2); color: #3b82f6; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem;">RAM ${event.mem_percent.toFixed(1)}%</span>`);
            }
            
            eventElement.className = 'event-item';
            eventElement.style.borderLeftColor = eventColor;
            eventElement.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="event-time" style="color: #666; font-size: 0.8rem;">${eventTime}</span>
                    <span style="font-size: 1.2rem;">${eventIcon}</span>
                    <span class="event-type" style="color: ${eventColor}; font-weight: 600; text-transform: uppercase; font-size: 0.75rem;">${eventLabel}</span>
                    <span style="color: #fff; font-weight: 500;">${event.comm || 'unknown'}</span>
                    <span style="color: #888; font-size: 0.85rem;">PID ${event.pid}</span>
                    ${event.ppid ? `<span style="color: #666; font-size: 0.75rem;">‚Üê ${event.ppid}</span>` : ''}
                    <span style="color: #888; font-size: 0.85rem;">‚Ä¢</span>
                    <span style="color: #888; font-size: 0.85rem;">${userName}</span>
                    ${metrics.length > 0 ? '<span style="margin-left: auto;"></span>' + metrics.join(' ') : ''}
                </div>
            `;
            
            // Add to top of events list
            eventsContainer.insertBefore(eventElement, eventsContainer.firstChild);
            
            // Keep only last 50 events
            const events = eventsContainer.children;
            while (events.length > 50) {
                eventsContainer.removeChild(events[events.length - 1]);
            }
        }
        
        // Initialize dashboard
        async function initialize() {
            console.log('Initializing Linnix Dashboard...');
            
            // Initial health check
            await checkServiceHealth();
            
            // Connect to event stream
            connectEventStream();
            
            // Set up periodic updates (optimized for performance)
            setInterval(checkServiceHealth, 30000);  // Every 30 seconds
            setInterval(loadSystemData, 15000);      // Every 15 seconds
            setInterval(loadProcesses, 20000);       // Every 20 seconds
            setInterval(loadInsights, 60000);        // Every 60 seconds
        }
        
        // Start when page loads
        window.addEventListener('load', initialize);
    </script>
</body>
</html>